{"version":3,"sources":["../src/rendering.js"],"names":["link","scope","elem","attrs","ctrl","data","panel","map","find","$tooltip","$","events","on","render","renderingCompleted","setElementHeight","height","row","_","isString","parseInt","replace","title","css","e","addMap","$panelContainer","parents","backgroundColor","firstChild","removeChild","L","setView","hovers","featureGroup","markers","tileLayer","maxZoom","attribution","addTo","invalidateSize","clearLayers","each","sat","isEmpty","trace","options","color","weight","opacity","lineCap","smoothFactor","colorize","multiOptions","optionIdxFn","latLng","prevLatLng","index","i","value","thresholds","isFinite","length","colors","c","groupIdx","reduce","prev","cur","timestamp","timeStep","groupBy","forEach","group","idx","line","multiOptionsPolyline","bindPopup","openPopup","circleMarker","last","radius","fillOpacity","marker","legendOnMap","icon","divIcon","html","iconSize","iconAnchor","point","fitBounds","getBounds","polar","canvas","document","createElement","style","display","margin","offsetHeight","width","offsetWidth","remove","className","appendChild","polarMap","PolarMap","center","polarCenter","drawLabels","drawTracks","colorizeTracks","draw"],"mappings":"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","file":"rendering.js","sourcesContent":["import _ from 'lodash';\r\nimport $ from 'jquery';\r\nimport './leaflet'\r\nimport './leaflet.css!';\r\nimport './MultiOptionsPolyline'\r\nimport PolarMap from './polar_map'\r\n\r\nexport default function link(scope, elem, attrs, ctrl) {\r\n  var data, panel, map;\r\n  elem = elem.find('.satmap-panel');\r\n  var $tooltip = $('<div id=\"tooltip\">');\r\n\r\n  ctrl.events.on('render', function() {\r\n    render();\r\n    ctrl.renderingCompleted();\r\n  });\r\n\r\n  function setElementHeight() {\r\n    try {\r\n      var height = ctrl.height || panel.height || ctrl.row.height;\r\n      if (_.isString(height)) {\r\n        height = parseInt(height.replace('px', ''), 10);\r\n      }\r\n\r\n      height -= 5; // padding\r\n      height -= panel.title ? 24 : 9; // subtract panel title bar\r\n\r\n      elem.css('height', height + 'px');\r\n\r\n      return true;\r\n    } catch(e) { // IE throws errors sometimes\r\n      return false;\r\n    }\r\n  }\r\n\r\n  function addMap() {\r\n    var $panelContainer = elem.parents('.panel-container');\r\n    var backgroundColor = $panelContainer.css('background-color');\r\n\r\n    if (!ctrl.map) {\r\n      while(elem[0].firstChild){\r\n        elem[0].removeChild(elem[0].firstChild);\r\n      }\r\n\r\n      ctrl.map = L.map(elem[0]).setView([45.0451232, 41.9260474], 3);\r\n      ctrl.hovers = L.featureGroup();\r\n      ctrl.markers = L.featureGroup();\r\n\r\n      L.tileLayer('http://{s}.tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png', {\r\n        maxZoom: 19,\r\n        attribution: '&copy; <a href=\"http://www.openstreetmap.org/copyright\">OpenStreetMap</a>'\r\n      }).addTo(ctrl.map);\r\n\r\n      ctrl.markers.addTo(ctrl.map);\r\n      ctrl.hovers.addTo(ctrl.map);\r\n    }\r\n\r\n    ctrl.map.invalidateSize();\r\n    ctrl.markers.clearLayers();\r\n\r\n    _.each(data, (sat) => {\r\n      if (_.isEmpty(sat.data)) {\r\n        return;\r\n      }\r\n\r\n      if (ctrl.panel.trace) {\r\n        var options = {\r\n          color: sat.color,\r\n          weight: 3,\r\n          opacity: 0.8,\r\n          lineCap: 'butt',\r\n          smoothFactor: 1\r\n        };\r\n\r\n        if (panel.colorize) {\r\n          options.multiOptions = {\r\n            optionIdxFn: function (latLng, prevLatLng, index) {\r\n              var i, value = latLng.value || 0, thresholds = panel.thresholds;\r\n\r\n              if (!_.isFinite(value)) {\r\n                return 0;\r\n              }\r\n\r\n              for (i = 0; i < thresholds.length; ++i) {\r\n                if (value <= thresholds[i]) {\r\n                    return i;\r\n                }\r\n              }\r\n\r\n              return thresholds.length;\r\n            },\r\n\r\n            options: panel.colors.map(c => { return { color: c }; })\r\n          };\r\n        }\r\n        else {\r\n          options.multiOptions = {\r\n            optionIdxFn: function() { return 0; },\r\n            options: [{color: sat.color}]\r\n          }\r\n        }\r\n\r\n        var groupIdx = 0;\r\n        sat.data[0].groupIdx = groupIdx;\r\n\r\n        _.reduce(sat.data, (prev, cur) => {\r\n            cur.groupIdx = (cur.timestamp - prev.timestamp) < sat.timeStep * 20 ? groupIdx : ++groupIdx;\r\n            return cur;\r\n        });\r\n\r\n        _(sat.data).groupBy('groupIdx').forEach((group, idx) => {\r\n          var line = new L.multiOptionsPolyline(group, options);\r\n          line.bindPopup(sat.sat);\r\n          line.addTo(ctrl.markers);\r\n          line.on('mouseover', function (e) { this.openPopup(); });\r\n\r\n          if (idx !== groupIdx) {\r\n            L.circleMarker(_.last(group), {\r\n              radius: 4,\r\n              color: sat.color,\r\n              fillOpacity: 1\r\n            }).addTo(ctrl.markers);\r\n          }\r\n        });\r\n      }\r\n\r\n      var marker = L.circleMarker(_.last(sat.data), {\r\n        radius: 6,\r\n        color: sat.color,\r\n        fillOpacity: 1,\r\n        sat: sat.sat\r\n      });\r\n\r\n      if (ctrl.panel.legendOnMap) {\r\n        L.marker(_.last(sat.data), {\r\n          icon: L.divIcon({html: '<div style=\"padding: 2px\">' + sat.sat + '</div>', iconSize: 'auto', iconAnchor: L.point(-6, -6)})\r\n        }).addTo(ctrl.markers);\r\n      }\r\n\r\n      marker.bindPopup(sat.sat);\r\n      marker.addTo(ctrl.markers);\r\n      marker.on('mouseover', function (e) { this.openPopup(); });\r\n    });\r\n\r\n    if (data.length > 0) {\r\n      ctrl.map.fitBounds(ctrl.markers.getBounds());\r\n    }\r\n  }\r\n\r\n  function render() {\r\n    if (!ctrl.data) { return; }\r\n\r\n    data = ctrl.data;\r\n    panel = ctrl.panel;\r\n\r\n    if (setElementHeight()) {\r\n      if (panel.polar) {\r\n        var canvas = document.createElement(\"canvas\");\r\n        canvas.style.display = 'block';\r\n        canvas.style.margin = '0 auto';\r\n        canvas.height = elem[0].offsetHeight;\r\n        canvas.width = elem[0].offsetWidth;\r\n\r\n        if (ctrl.map) {\r\n          ctrl.map.remove();\r\n          ctrl.hovers = ctrl.markers = ctrl.map = null;\r\n        }\r\n\r\n        while(elem[0].firstChild){\r\n          elem[0].removeChild(elem[0].firstChild);\r\n        }\r\n\r\n        elem[0].className = 'satmap-panel';\r\n        elem[0].appendChild(canvas);\r\n\r\n        var polarMap = new PolarMap(canvas, {\r\n          center: panel.polarCenter,\r\n          drawLabels: panel.legendOnMap,\r\n          drawTracks: panel.trace,\r\n          colorizeTracks: panel.colorize,\r\n          thresholds: panel.thresholds,\r\n          colors: panel.colors\r\n        });\r\n\r\n        polarMap.draw(data);\r\n      }\r\n      else {\r\n        addMap();\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n"]}