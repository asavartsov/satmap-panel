{"version":3,"sources":["../src/rendering.js"],"names":[],"mappings":"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","file":"rendering.js","sourcesContent":["import _ from 'lodash';\nimport $ from 'jquery';\nimport './leaflet'\nimport './leaflet.css!';\nimport './MultiOptionsPolyline'\n\nexport default function link(scope, elem, attrs, ctrl) {\n  var data, panel, map;\n  elem = elem.find('.piechart-panel');\n  var $tooltip = $('<div id=\"tooltip\">');\n\n  ctrl.events.on('render', function() {\n    render();\n    ctrl.renderingCompleted();\n  });\n\n  function setElementHeight() {\n    try {\n      var height = ctrl.height || panel.height || ctrl.row.height;\n      if (_.isString(height)) {\n        height = parseInt(height.replace('px', ''), 10);\n      }\n\n      height -= 5; // padding\n      height -= panel.title ? 24 : 9; // subtract panel title bar\n\n      elem.css('height', height + 'px');\n\n      return true;\n    } catch(e) { // IE throws errors sometimes\n      return false;\n    }\n  }\n\n  function addMap() {\n    var $panelContainer = elem.parents('.panel-container');\n    var backgroundColor = $panelContainer.css('background-color');\n    \n    if (!ctrl.map) {\n      ctrl.map = L.map(elem[0]).setView([45.0451232, 41.9260474], 3);\n      ctrl.markers = L.featureGroup();\n      \n      L.tileLayer('http://{s}.tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png', {\n        maxZoom: 19,\n        attribution: '&copy; <a href=\"http://www.openstreetmap.org/copyright\">OpenStreetMap</a>'\n      }).addTo(ctrl.map);\n      \n      ctrl.markers.addTo(ctrl.map);\n    }\n    \n    ctrl.map.invalidateSize();\n    ctrl.markers.clearLayers();\n    \n    _.each(data, (sat) => {\n      if (_.isEmpty(sat.data)) {\n        return;\n      }\n      \n      if (ctrl.panel.trace) {\n        // var points = _.map(sat.data, (pos) => L.latLng(pos[0], pos[1]));\n        \n        var line = new L.multiOptionsPolyline(sat.data, {\n          multiOptions: {\n              optionIdxFn: function (latLng, prevLatLng, index) {\n                var i, value = latLng.value, thresholds = [0.2, 0.3, 0.335];\n                \n                for (i = 0; i < thresholds.length; ++i) {\n                  if (value <= thresholds[i]) {\n                      return i;\n                  }\n                }\n\n                return thresholds.length;\n              },\n\n              options: [\n                  {color: '#5b94ff'},\n                  {color: '#58ef5b'},\n                  {color: '#fff882'},\n                  {color: '#ff5b5b'}\n              ]\n          },\n          color: sat.color,\n          weight: 3,\n          opacity: 0.8,\n          lineCap: 'butt',\n          smoothFactor: 1\n        });\n        \n        line.bindPopup(sat.sat);\n        line.addTo(ctrl.markers);\n        line.on('mouseover', function (e) { this.openPopup(); });  \n      }\n      \n      var marker = L.circleMarker(_.last(sat.data), {\n        radius: 6,\n        color: sat.color,\n        fillOpacity: 1,\n        sat: sat.sat\n      });\n      \n      if (ctrl.panel.legendType == \"На карте\") {\n        L.marker(_.last(sat.data), {\n          icon: L.divIcon({html: '<div style=\"padding: 2px\">' + sat.sat + '</div>', iconSize: 'auto', iconAnchor: L.point(-6, -6)})\n        }).addTo(ctrl.markers);\n      }\n      \n      marker.bindPopup(sat.sat);\n      marker.addTo(ctrl.markers);\n      marker.on('mouseover', function (e) { this.openPopup(); });\n    });\n  }\n\n  function render() {\n    if (!ctrl.data) { return; }\n\n    data = ctrl.data;\n    panel = ctrl.panel;\n\n    if (setElementHeight()) {\n      addMap();\n    }\n  }\n}\n\n"]}